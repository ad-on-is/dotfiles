#!/bin/bash

# rg-sd-preview.sh - Preview replacements before applying them
# Usage: ./rg-sd-preview.sh "search_pattern" "replacement" [--go]

set -e

GO_FLAG=false

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
  --go)
    GO_FLAG=true
    shift
    ;;
  *)
    if [ -z "$SEARCH_PATTERN" ]; then
      SEARCH_PATTERN="$1"
    elif [ -z "$REPLACEMENT" ]; then
      REPLACEMENT="$1"
    else
      echo "Error: Too many arguments"
      exit 1
    fi
    shift
    ;;
  esac
done

if [ -z "$SEARCH_PATTERN" ] || [ -z "$REPLACEMENT" ]; then
  echo "Usage: $0 'search_pattern' 'replacement' [--go]"
  echo "Example: $0 'old_string' 'new_string'"
  echo "Example: $0 'old_string' 'new_string' --go"
  echo ""
  echo "Options:"
  echo "  --go    Apply changes immediately without preview"
  exit 1
fi

# Check if rg and sd are available
if ! command -v rg &>/dev/null; then
  echo "Error: ripgrep (rg) is not installed"
  exit 1
fi

if ! command -v sd &>/dev/null; then
  echo "Error: sd is not installed"
  exit 1
fi

# If --go flag is set, apply changes immediately
if [ "$GO_FLAG" = true ]; then
  count=$(rg "$SEARCH_PATTERN" -l | wc -l)
  rg "$SEARCH_PATTERN" -l | xargs sd "$SEARCH_PATTERN" "$REPLACEMENT"
  echo "Changes applied to $count files."
  exit 0
fi

# Get list of files containing the search pattern
FILES=$(rg "$SEARCH_PATTERN" -l)

if [ -z "$FILES" ]; then
  echo "No files found containing: $SEARCH_PATTERN"
  exit 0
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "Preview of changes:"
echo "=================="
echo

# Process each file
count=$(echo "$FILES" | wc -l)
echo "$FILES" | while IFS= read -r file; do
  echo "$file"

  # Get the original lines that match
  rg "$SEARCH_PATTERN" -n "$file" | while IFS=: read -r line_num line_content; do
    echo -e "${RED}-$line_num: $SEARCH_PATTERN${NC}"
  done

  # Get the replaced lines using sd on each matching line
  rg "$SEARCH_PATTERN" -n "$file" | while IFS=: read -r line_num line_content; do
    echo -e "${GREEN}+$line_num: $REPLACEMENT${NC}"
  done

  echo
done

echo "=================="
echo "To apply changes for $count files, run:"
echo "rgsd '$SEARCH_PATTERN' '$REPLACEMENT' --go"
